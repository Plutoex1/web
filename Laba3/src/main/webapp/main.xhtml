<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets">
<h:head>
    <meta charset="UTF-8"/>
    <title>Лабораторная работа №3</title>
    <h:outputStylesheet name="css/style.css"/>
</h:head>
<h:body>
    <div class="container">
        <header class="header">
            <div class="title">Рязанов Григорий Алексеевич</div>
            <div class="subtitle">Группа: P3211 • Вариант: 666</div>
        </header>

        <h:form id="main-form">
            <p:growl id="growl" showDetail="true" life="4000"/>
            <div class="grid">
                <div class="card">
                    <h2>Ввод данных</h2>
                    <div class="form">
                        <div class="form-row">
                            <p:outputLabel value="X:"/>
                            <h:panelGroup id="x-buttons">
                                <div class="x-list">
                                    <p:commandButton value="-3" action="#{resultsManager.setX(-3.0)}" update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == -3.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="-2" action="#{resultsManager.setX(-2.0)}" update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == -2.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="-1" action="#{resultsManager.setX(-1.0)}" update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == -1.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="0"  action="#{resultsManager.setX(0.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 0.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="1"  action="#{resultsManager.setX(1.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 1.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="2"  action="#{resultsManager.setX(2.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 2.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="3"  action="#{resultsManager.setX(3.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 3.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="4"  action="#{resultsManager.setX(4.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 4.0 ? 'x-selected' : ''}"/>
                                    <p:commandButton value="5"  action="#{resultsManager.setX(5.0)}"  update="x-hidden x-buttons" process="@this" styleClass="#{resultsManager.selectedX == 5.0 ? 'x-selected' : ''}"/>
                                </div>
                                <h:inputHidden id="x-hidden" value="#{resultsManager.newResult.x}" required="true" requiredMessage="Выберите значение X."/>
                            </h:panelGroup>
                        </div>
                        <div class="form-row">
                            <p:outputLabel for="y-input" value="Y:"/>
                            <!-- !!! ДОБАВЛЕНО: maxlength="10" ограничивает длину ввода !!! -->
                            <p:inputText id="y-input"
                                         value="#{resultsManager.newResult.y}"
                                         placeholder="(-3 ... 5)"
                                         maxlength="10"
                                         required="true"
                                         requiredMessage="Поле Y не может быть пустым."
                                         validator="yValidator"/>
                        </div>
                        <div class="form-row">
                            <p:outputLabel for="r-radio" value="R:"/>
                            <p:selectOneRadio id="r-radio" value="#{resultsManager.newResult.r}" required="true" requiredMessage="Выберите значение R.">
                                <f:selectItem itemLabel="1" itemValue="1.0"/>
                                <f:selectItem itemLabel="1.5" itemValue="1.5"/>
                                <f:selectItem itemLabel="2" itemValue="2.0"/>
                                <f:selectItem itemLabel="2.5" itemValue="2.5"/>
                                <f:selectItem itemLabel="3" itemValue="3.0"/>
                                <p:ajax update="graph"/>
                            </p:selectOneRadio>
                        </div>
                        <div class="form-actions">
                            <p:commandButton value="Проверить" action="#{resultsManager.addResultFromForm}" update="@form" styleClass="btn primary"/>
                            <p:commandButton value="Очистить" action="#{resultsManager.clearResults}" update="@form" styleClass="btn" immediate="true"/>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <h2>График</h2>
                    <h:panelGroup id="graph" layout="block" styleClass="graph-wrap">
                        <svg width="320" height="320" viewBox="0 0 320 320" onclick="sendClickByGraph(event)">
                            <!-- ОБЛАСТЬ ПОПАДАНИЯ -->
                            <g fill="#4ea5ff" fill-opacity="0.4" stroke="#2684ff">
                                <!-- 2 четверть: прямоугольник -->
                                <rect x="#{160 - resultsManager.newResult.r * 40 / 2}"
                                      y="#{160 - resultsManager.newResult.r * 40}"
                                      width="#{resultsManager.newResult.r * 40 / 2}"
                                      height="#{resultsManager.newResult.r * 40}"/>
                                <!-- 3 четверть: треугольник -->
                                <polygon points="160,160 #{160 - resultsManager.newResult.r * 40},160 160,#{160 + resultsManager.newResult.r * 40 / 2}"/>
                                <!-- 4 четверть: четверть окружности -->
                                <path d="M 160,160 L #{160 + resultsManager.newResult.r * 40 / 2},160 A #{resultsManager.newResult.r*40/2},#{resultsManager.newResult.r*40/2} 0 0 1 160,#{160 + resultsManager.newResult.r * 40 / 2} Z"/>
                            </g>

                            <!-- ОСИ КООРДИНАТ -->
                            <line x1="10" y1="160" x2="310" y2="160" stroke="#ccc" stroke-width="1"/>
                            <line x1="160" y1="10" x2="160" y2="310" stroke="#ccc" stroke-width="1"/>

                            <!-- СТРЕЛКИ НА ОСЯХ -->
                            <polygon points="310,160 305,157 305,163" fill="#ccc"/>
                            <polygon points="160,10 157,15 163,15" fill="#ccc"/>

                            <!-- !!! ИСПРАВЛЕНО: КОНКРЕТНЫЕ ЦИФРЫ ВМЕСТО R !!! -->
                            <!-- Вычисляем значения на основе R -->
                            <ui:param name="r" value="#{resultsManager.newResult.r}"/>
                            <ui:param name="rHalf" value="#{resultsManager.newResult.r / 2}"/>
                            <ui:param name="rDouble" value="#{resultsManager.newResult.r * 2}"/>

                            <!-- Отметки на оси X -->
                            <line x1="#{160 - r * 40}" y1="155" x2="#{160 - r * 40}" y2="165" stroke="#ccc" stroke-width="1"/>
                            <line x1="#{160 + r * 40}" y1="155" x2="#{160 + r * 40}" y2="165" stroke="#ccc" stroke-width="1"/>
                            <line x1="#{160 - rDouble * 40}" y1="155" x2="#{160 - rDouble * 40}" y2="165" stroke="#ccc" stroke-width="1"/>
                            <line x1="#{160 + rDouble * 40}" y1="155" x2="#{160 + rDouble * 40}" y2="165" stroke="#ccc" stroke-width="1"/>

                            <!-- Отметки на оси Y -->
                            <line x1="155" y1="#{160 - r * 40}" x2="165" y2="#{160 - r * 40}" stroke="#ccc" stroke-width="1"/>
                            <line x1="155" y1="#{160 + r * 40}" x2="165" y2="#{160 + r * 40}" stroke="#ccc" stroke-width="1"/>
                            <line x1="155" y1="#{160 - rDouble * 40}" x2="165" y2="#{160 - rDouble * 40}" stroke="#ccc" stroke-width="1"/>
                            <line x1="155" y1="#{160 + rDouble * 40}" x2="165" y2="#{160 + rDouble * 40}" stroke="#ccc" stroke-width="1"/>

                            <!-- ПОДПИСИ КОНКРЕТНЫХ ЗНАЧЕНИЙ на оси X -->
                            <text x="#{160 - r * 40}" y="178" fill="#9ca3af" font-size="11" text-anchor="middle">
                                <h:outputText value="#{-r}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="#{160 - rDouble * 40}" y="178" fill="#9ca3af" font-size="11" text-anchor="middle">
                                <h:outputText value="#{-rDouble}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="#{160 + r * 40}" y="178" fill="#9ca3af" font-size="11" text-anchor="middle">
                                <h:outputText value="#{r}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="#{160 + rDouble * 40}" y="178" fill="#9ca3af" font-size="11" text-anchor="middle">
                                <h:outputText value="#{rDouble}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>

                            <!-- ПОДПИСИ КОНКРЕТНЫХ ЗНАЧЕНИЙ на оси Y -->
                            <text x="145" y="#{160 - r * 40 + 4}" fill="#9ca3af" font-size="11" text-anchor="end">
                                <h:outputText value="#{r}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="145" y="#{160 - rDouble * 40 + 4}" fill="#9ca3af" font-size="11" text-anchor="end">
                                <h:outputText value="#{rDouble}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="145" y="#{160 + r * 40 + 4}" fill="#9ca3af" font-size="11" text-anchor="end">
                                <h:outputText value="#{-r}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>
                            <text x="145" y="#{160 + rDouble * 40 + 4}" fill="#9ca3af" font-size="11" text-anchor="end">
                                <h:outputText value="#{-rDouble}">
                                    <f:convertNumber maxFractionDigits="1"/>
                                </h:outputText>
                            </text>

                            <!-- ПОДПИСИ ОСЕЙ -->
                            <text x="300" y="152" fill="#9ca3af" font-size="13" font-weight="bold">X</text>
                            <text x="168" y="20" fill="#9ca3af" font-size="13" font-weight="bold">Y</text>

                            <!-- ТОЧКИ РЕЗУЛЬТАТОВ -->
                            <ui:repeat value="#{resultsManager.results}" var="p">
                                <circle cx="#{160 + p.x * 40}" cy="#{160 - p.y * 40}" r="3.5" fill="#{p.hit ? '#2e7d32' : '#c62828'}"/>
                            </ui:repeat>
                        </svg>
                    </h:panelGroup>
                </div>
            </div>
            <div class="card" style="grid-column: 1 / -1;">
                <h2>Результаты</h2>
                <p:dataTable id="result-table" var="res" value="#{resultsManager.results}" paginator="true" rows="5" emptyMessage="Нет данных для отображения">
                    <p:column headerText="X"><h:outputText value="#{res.x}"/></p:column>
                    <p:column headerText="Y"><h:outputText value="#{res.y}"/></p:column>
                    <p:column headerText="R"><h:outputText value="#{res.r}"/></p:column>
                    <p:column headerText="Попадание"><h:outputText value="#{res.hit ? 'Да' : 'Нет'}" styleClass="#{res.hit ? 'hit' : 'miss'}"/></p:column>
                    <p:column headerText="Время"><h:outputText value="#{res.formattedServerTime}"/></p:column>
                    <p:column headerText="Выполнение (нс)"><h:outputText value="#{res.execTimeNs}"/></p:column>
                </p:dataTable>
            </div>
            <p:commandButton value="На стартовую" action="to-index" style="margin-top: 16px;" styleClass="btn" immediate="true"/>
            <p:remoteCommand name="sendClick" action="#{resultsManager.addResultFromGraph}" update="@form" process="@this"/>
        </h:form>
    </div>
    <script type="text/javascript">
        //<![CDATA[
        function sendClickByGraph(event) {
            const rRadio = document.querySelector('input[name="main-form:r-radio"]:checked');
            if (!rRadio) {
                if (window.PF && PF('growl')) {
                    PF('growl').renderMessage({
                        summary: 'Ошибка',
                        detail: 'Для клика по графику сначала выберите R.',
                        severity: 'error'
                    });
                }
                return;
            }
            const r = parseFloat(rRadio.value);
            const svg = event.currentTarget;
            const rect = svg.getBoundingClientRect();
            const svgX = event.clientX - rect.left;
            const svgY = event.clientY - rect.top;
            const scaleFactor = 40;
            const x = (svgX - 160) / scaleFactor;
            const y = (160 - svgY) / scaleFactor;
            sendClick([{name: 'x', value: x}, {name: 'y', value: y}, {name: 'r', value: r}]);
        }
        //]]>
    </script>
</h:body>
</html>